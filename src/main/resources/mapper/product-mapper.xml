<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.store.mapper.ProductMapper">

    <resultMap id="ProductResultMap" type="com.example.store.entity.product.Product">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="price" column="price"/>
        <result property="quantity" column="quantity"/>

        <association property="category" javaType="com.example.store.entity.Category">
            <id property="id" column="category_id"/>
        </association>
    </resultMap>

    <select id="getProductsByOption" resultMap="ProductResultMap">
        SELECT *
        FROM product
        WHERE
        (#{categoryId} IS NULL OR category_id = #{categoryId})
        AND (#{title} IS NULL OR title LIKE CONCAT('%', #{title}, '%'))

        <if test="sort != null and order != null">
            ORDER BY
            <choose>
                <when test="sort == 'price'">price</when>
                <when test="sort == 'orderquantity'">sale_quantity</when>
                <otherwise>price</otherwise>
            </choose>
            <choose>
                <when test="order == 'asc'">ASC</when>
                <when test="order == 'desc'">DESC</when>
                <otherwise>ASC</otherwise>
            </choose>
        </if>
    </select>

    <select id="getProductsByOptionAfterIndex" resultMap="ProductResultMap">
        SELECT *
        FROM product_after_index FORCE INDEX (idx_category_title_after_index)
        WHERE
        (#{categoryId} IS NULL OR category_id = #{categoryId})
        AND (#{title} IS NULL OR title LIKE CONCAT(#{title}, '%'))

        <if test="sort != null and order != null">
            ORDER BY
            <choose>
                <when test="sort == 'price'">price</when>
                <when test="sort == 'orderquantity'">sale_quantity</when>
                <otherwise>price</otherwise>
            </choose>
            <choose>
                <when test="order == 'asc'">ASC</when>
                <when test="order == 'desc'">DESC</when>
                <otherwise>ASC</otherwise>
            </choose>
        </if>
    </select>
</mapper>